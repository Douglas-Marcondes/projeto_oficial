<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Nova An√°lise - Mapeador de Vocabul√°rio</title>
    <link rel="stylesheet" href="../../css/estilo-comum.css">
    <link rel="stylesheet" href="nova-analise.css">
    <style>
      .oculto { display: none; }
    </style>
</head>

<body class="pagina-nova-analise">

    <div class="container">
        <h1>üìù Nova An√°lise</h1>

        <div class="card-nova-analise">
            <label for="titulo-texto">T√≠tulo</label>
            <input type="text" id="titulo-texto" placeholder="T√≠tulo do texto">

            <label for="conteudo-texto">Conte√∫do</label>
            <textarea id="conteudo-texto" oninput="atualizarContador()" placeholder="Digite seu texto aqui..."></textarea>
            <div id="contador-caracteres">0 caracteres</div>

            <label for="tipo-analise">Tipo de an√°lise</label>
            <select id="tipo-analise">
                <option value="basica">B√°sica</option>
                <option value="avancada">Avan√ßada</option>
            </select>

            <button id="btn-analisar">üîç Analisar</button>
        </div>

        <div id="resultados-rapidos" class="oculto">
            <h2>üìä Resultados</h2>
            <div id="conteudo-resultados"></div>

            <button id="btn-salvar">üíæ Salvar</button>
        </div>
    </div>

<!-- ======================================================
     üî• FIREBASE COMPAT ‚Äî CARREGAR ANTES DO SEU SCRIPT
======================================================= -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
    // ============================
    // SEU FIREBASE REAL
    // ============================
    const firebaseConfig = {
        apiKey: "AIzaSyBb4Rlzw-z9GSUFCS6TQ35SIyKETEgqg7g",
        authDomain: "cadastro-tb-61070.firebaseapp.com",
        databaseURL: "https://cadastro-tb-61070-default-rtdb.firebaseio.com",
        projectId: "cadastro-tb-61070",
        storageBucket: "cadastro-tb-61070.firebasestorage.app",
        messagingSenderId: "80187170645",
        appId: "1:80187170645:web:552d5cb4ab1972766019dc"
    };

    // Inicializar firebase compat corretamente
    try {
        if (typeof firebase !== "undefined") {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            window.db = firebase.database(); // funciona 100%
        } else {
            console.error("Firebase n√£o carregou. Verifique a CDN.");
        }
    } catch (e) {
        console.error("Erro ao inicializar Firebase:", e);
    }

    // Usu√°rio logado
    try {
        window.usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
    } catch (e) {
        window.usuarioLogado = null;
    }
</script>

<!-- ======================================================
     üìå SEU SCRIPT PRINCIPAL
======================================================= -->
<script>

function getDatabaseSafe() {
    if (window.db) return window.db;

    if (typeof firebase !== "undefined" && firebase.database) {
        try { return firebase.database(); }
        catch { return null; }
    }
    return null;
}

/* -----------------------------------------
   üß† CLASSE ANALISADORA DE TEXTO
----------------------------------------- */
class AnalisadorTexto {
    limpar(texto) {
        return texto
            .toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^\w\s]/g, " ")
            .split(/\s+/)
            .filter(t => t.length > 2);
    }

    frequencia(palavras) {
        const f = {};
        palavras.forEach(p => f[p] = (f[p] || 0) + 1);
        return f;
    }

    processar(texto) {
        let palavras = this.limpar(texto);
        let freq = this.frequencia(palavras);

        return {
            total: palavras.length,
            unicas: Object.keys(freq).length,
            palavras: Object.entries(freq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([p, c]) => ({ palavra: p, contagem: c }))
        };
    }
}

let analisador = new AnalisadorTexto();
let resultadoAtual = null;

/* -----------------------------------------
   Fun√ß√µes
----------------------------------------- */
function atualizarContador() {
    const txt = document.getElementById("conteudo-texto").value;
    document.getElementById("contador-caracteres").innerHTML =
        `${txt.length} caracteres`;
}

function analisarTexto() {
    const titulo = document.getElementById("titulo-texto").value.trim();
    const texto = document.getElementById("conteudo-texto").value.trim();

    if (texto.length < 20) return alert("Digite um texto maior");

    resultadoAtual = analisador.processar(texto);
    resultadoAtual.titulo = titulo;
    resultadoAtual.textoOriginal = texto;

    mostrarResultados();
}

function mostrarResultados() {
    const div = document.getElementById("conteudo-resultados");

    let html = `
        <p><strong>Total de palavras:</strong> ${resultadoAtual.total}</p>
        <p><strong>Palavras √∫nicas:</strong> ${resultadoAtual.unicas}</p>
        <h3>Top palavras:</h3>
    `;

    resultadoAtual.palavras.forEach(p => {
        html += `<p>${p.palavra} ‚Äî ${p.contagem}</p>`;
    });

    div.innerHTML = html;
    document.getElementById("resultados-rapidos").classList.remove("oculto");
}

/* -----------------------------------------
   üíæ SALVAR NO FIREBASE
----------------------------------------- */
function salvarAnalise() {
    if (!resultadoAtual)
        return alert("Fa√ßa uma an√°lise primeiro!");

    const user = window.usuarioLogado;
    if (!user || !user.id)
        return alert("Erro: usu√°rio n√£o encontrado. Fa√ßa login primeiro.");

    const database = getDatabaseSafe();
    if (!database) {
        alert("Erro: Firebase n√£o inicializado.");
        return;
    }

    const id = Date.now();

    const dados = {
        idAnalise: id,
        usuarioId: user.id,
        titulo: resultadoAtual.titulo,
        textoOriginal: resultadoAtual.textoOriginal,
        resultado: resultadoAtual,
        data: new Date().toISOString()
    };

    database.ref("analises/" + user.id + "/" + id)
        .set(dados)
        .then(() => alert("An√°lise salva com sucesso!"))
        .catch(err => {
            console.error("Erro ao salvar:", err);
            alert("Erro ao salvar no Firebase.");
        });
}

/* -----------------------------------------
   EVENTOS
----------------------------------------- */
document.getElementById("btn-analisar").addEventListener("click", analisarTexto);
document.getElementById("btn-salvar").addEventListener("click", salvarAnalise);

</script>

</body>
</html>
