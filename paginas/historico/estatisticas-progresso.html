<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatÃ­sticas de Progresso - Mapeador de VocabulÃ¡rio</title>
    <link rel="stylesheet" href="../../css/estilo-comum.css">
    <link rel="stylesheet" href="estatisticas-progresso.css">
</head>
<body class="pagina-estatisticas-progresso">
    <div class="container">
        <div class="cabecalho-estatisticas-progresso">
            <h1 class="titulo-principal">ğŸ“ˆ EstatÃ­sticas de Progresso</h1>
            <p class="subtitulo">Acompanhe sua evoluÃ§Ã£o na escrita</p>
        </div>

        <nav class="navegacao">
            <ul class="lista-navegacao">
                <li class="item-navegacao"><a href="../dashboard/index.html" class="botao botao-pequeno">ğŸ  Dashboard</a></li>
                <li class="item-navegacao"><a href="meus-textos.html" class="botao botao-pequeno">ğŸ“š Meus Textos</a></li>
                <li class="item-navegacao"><a href="estatisticas-progresso.html" class="botao botao-pequeno">ğŸ“ˆ Progresso</a></li>
                <li class="item-navegacao"><a href="../ferramentas/dicionario-pessoal.html" class="botao botao-pequeno">ğŸ“– DicionÃ¡rio</a></li>
                <li class="item-navegacao"><a href="#" onclick="sair()" class="botao botao-perigo botao-pequeno">ğŸšª Sair</a></li>
            </ul>
        </nav>

        <div class="card-estatisticas-progresso">
            <h2 class="titulo-card-estatisticas-progresso">ğŸ“Š EvoluÃ§Ã£o da Sua Escrita</h2>
            
            <div class="grade-dashboard">
                <div class="item-grade">
                    <h3>ğŸ“ˆ Diversidade Lexical ao Longo do Tempo</h3>
                    <div class="grafico-evolucao-container">
                        <div class="linha-evolucao" id="grafico-evolucao">
                            <!-- GrÃ¡fico serÃ¡ gerado via JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="item-grade">
                    <h3>ğŸ¯ MÃ©tricas de Progresso</h3>
                    <div class="metricas-progresso-container">
                        <div class="lista-metricas-progresso" id="metricas-progresso">
                            <!-- MÃ©tricas serÃ£o preenchidas via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="grade-dashboard" style="margin-top: 20px;">
                <div class="item-grade">
                    <h3>ğŸ“ Seus PadrÃµes de Escrita</h3>
                    <div class="padroes-escrita-container">
                        <div id="padroes-escrita">
                            <p><strong>Palavras que vocÃª estÃ¡ usando mais:</strong></p>
                            <div class="lista-palavras-evolucao" id="palavras-aumento"></div>
                            
                            <p style="margin-top: 15px;"><strong>Palavras que vocÃª estÃ¡ usando menos:</strong></p>
                            <div class="lista-palavras-evolucao" id="palavras-reducao"></div>
                        </div>
                    </div>
                </div>

                <div class="item-grade">
                    <h3>ğŸ† Conquistas</h3>
                    <div class="conquistas-container" id="conquistas">
                        <!-- Conquistas serÃ£o preenchidas via JavaScript -->
                    </div>
                </div>
            </div>

            <div class="texto-centralizado" style="margin-top: 30px;">
                <a href="../dashboard/nova-analise.html" class="botao botao-sucesso">ğŸ“ Continuar Escrevendo</a>
                <a href="../ferramentas/metas-escrita.html" class="botao">ğŸ¯ Definir Metas</a>
                <a href="meus-textos.html" class="botao botao-secundario">ğŸ“š Ver Todos os Textos</a>
            </div>
        </div>
    </div>

    <script>
        // Verificar se estÃ¡ logado
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        if (!usuarioLogado) {
            window.location.href = '../auth/login.html';
        }

        function carregarEstatisticasProgresso() {
            const textos = JSON.parse(localStorage.getItem('textos')) || [];
            const textosUsuario = textos.filter(t => t.usuarioId === usuarioLogado.id);
            
            if (textosUsuario.length === 0) {
                exibirMensagemSemDados();
                return;
            }

            exibirGraficoEvolucao(textosUsuario);
            exibirMetricasProgresso(textosUsuario);
            exibirPadroesEscrita(textosUsuario);
            exibirConquistas(textosUsuario);
        }

        function exibirGraficoEvolucao(textos) {
            const graficoContainer = document.getElementById('grafico-evolucao');
            const textosOrdenados = textos.sort((a, b) => new Date(a.data) - new Date(b.data));
            
            // Pegar os Ãºltimos 6 textos ou todos se tiver menos
            const textosParaGrafico = textosOrdenados.slice(-6);
            const valoresDiversidade = textosParaGrafico.map(t => parseFloat(t.analise?.diversidade) || 0);
            
            if (valoresDiversidade.length === 0) return;

            const maxDiversidade = Math.max(...valoresDiversidade);
            const containerWidth = 500; // Largura aproximada do container
            const containerHeight = 200;
            const espacamento = containerWidth / (valoresDiversidade.length - 1);

            let html = '';
            let pontosAnteriores = [];

            textosParaGrafico.forEach((texto, index) => {
                const diversidade = parseFloat(texto.analise?.diversidade) || 0;
                const x = index * espacamento;
                const y = containerHeight - (diversidade / maxDiversidade) * containerHeight;
                
                // Ponto
                html += `<div class="ponto-evolucao" style="left: ${x}px; top: ${y}px;" title="${new Date(texto.data).toLocaleDateString()}: ${diversidade}%"></div>`;
                
                // Linha conectando pontos
                if (index > 0) {
                    const xAnterior = (index - 1) * espacamento;
                    const yAnterior = containerHeight - (valoresDiversidade[index - 1] / maxDiversidade) * containerHeight;
                    
                    const distancia = Math.sqrt(Math.pow(x - xAnterior, 2) + Math.pow(y - yAnterior, 2));
                    const angulo = Math.atan2(y - yAnterior, x - xAnterior) * 180 / Math.PI;
                    
                    html += `<div class="linha-conexao" style="left: ${xAnterior}px; top: ${yAnterior}px; width: ${distancia}px; transform: rotate(${angulo}deg);"></div>`;
                }
            });

            graficoContainer.innerHTML = html;
        }

        function exibirMetricasProgresso(textos) {
            const container = document.getElementById('metricas-progresso');
            
            const totalTextos = textos.length;
            const mediaPalavras = textos.reduce((sum, t) => sum + (t.analise?.totalPalavras || 0), 0) / totalTextos;
            
            // Calcular evoluÃ§Ã£o da diversidade
            const textosOrdenados = textos.sort((a, b) => new Date(a.data) - new Date(b.data));
            const primeiraDiversidade = parseFloat(textosOrdenados[0]?.analise?.diversidade) || 0;
            const ultimaDiversidade = parseFloat(textosOrdenados[textosOrdenados.length - 1]?.analise?.diversidade) || 0;
            const evolucaoDiversidade = ultimaDiversidade - primeiraDiversidade;
            
            // PerÃ­odo analisado
            const primeiraData = new Date(textosOrdenados[0].data);
            const ultimaData = new Date(textosOrdenados[textosOrdenados.length - 1].data);
            const diferencaDias = Math.ceil((ultimaData - primeiraData) / (1000 * 60 * 60 * 24));

            const metricas = [
                { label: 'MÃ©dia de Palavras por Texto', valor: Math.round(mediaPalavras) },
                { label: 'EvoluÃ§Ã£o da Diversidade', valor: `${evolucaoDiversidade >= 0 ? '+' : ''}${evolucaoDiversidade.toFixed(1)}%` },
                { label: 'Textos Analisados', valor: totalTextos },
                { label: 'PerÃ­odo Analisado', valor: `${diferencaDias} dias` }
            ];

            container.innerHTML = metricas.map(metrica => `
                <div class="item-metrica-progresso">
                    <span class="valor-metrica-progresso">${metrica.valor}</span>
                    <span class="rotulo-metrica-progresso">${metrica.label}</span>
                </div>
            `).join('');
        }

        function exibirPadroesEscrita(textos) {
            // AnÃ¡lise simplificada de padrÃµes
            const todasPalavras = {};
            
            textos.forEach(texto => {
                if (texto.analise && texto.analise.palavras) {
                    texto.analise.palavras.forEach(palavraObj => {
                        if (!todasPalavras[palavraObj.palavra]) {
                            todasPalavras[palavraObj.palavra] = [];
                        }
                        todasPalavras[palavraObj.palavra].push({
                            frequencia: palavraObj.frequencia,
                            data: texto.data
                        });
                    });
                }
            });

            // Exemplo simplificado - em um sistema real, faria anÃ¡lise temporal mais complexa
            const palavrasAumento = Object.keys(todasPalavras).slice(0, 3);
            const palavrasReducao = Object.keys(todasPalavras).slice(3, 6);

            document.getElementById('palavras-aumento').innerHTML = palavrasAumento.map(p => 
                `<span class="tag-evolucao tag-aumento">${p}</span>`
            ).join('');

            document.getElementById('palavras-reducao').innerHTML = palavrasReducao.map(p => 
                `<span class="tag-evolucao tag-reducao">${p}</span>`
            ).join('');
        }

        function exibirConquistas(textos) {
            const container = document.getElementById('conquistas');
            const conquistas = [];

            // Conquista: Primeiros textos
            if (textos.length >= 1) {
                conquistas.push({
                    tipo: 'sucesso',
                    titulo: 'ğŸ‰ Primeira AnÃ¡lise!',
                    descricao: 'VocÃª realizou sua primeira anÃ¡lise de texto'
                });
            }

            // Conquista: 5 textos
            if (textos.length >= 5) {
                conquistas.push({
                    tipo: 'info',
                    titulo: 'ğŸ“š Escrita Consistente',
                    descricao: 'VocÃª analisou 5 textos diferentes'
                });
            }

            // Conquista: Diversidade melhorada
            const textosOrdenados = textos.sort((a, b) => new Date(a.data) - new Date(b.data));
            if (textosOrdenados.length >= 2) {
                const primeiraDiversidade = parseFloat(textosOrdenados[0]?.analise?.diversidade) || 0;
                const ultimaDiversidade = parseFloat(textosOrdenados[textosOrdenados.length - 1]?.analise?.diversidade) || 0;
                
                if (ultimaDiversidade > primeiraDiversidade + 5) {
                    conquistas.push({
                        tipo: 'sucesso',
                        titulo: 'ğŸ“ˆ Diversidade Melhorada!',
                        descricao: `Sua diversidade lexical aumentou ${(ultimaDiversidade - primeiraDiversidade).toFixed(1)}%`
                    });
                }
            }

            if (conquistas.length === 0) {
                container.innerHTML = '<p>Continue escrevendo para desbloquear conquistas!</p>';
                return;
            }

            container.innerHTML = conquistas.map(conquista => `
                <div class="conquista-item conquista-${conquista.tipo}">
                    <strong>${conquista.titulo}</strong><br>
                    ${conquista.descricao}
                </div>
            `).join('');
        }

        function exibirMensagemSemDados() {
            document.querySelector('.card-estatisticas-progresso').innerHTML = `
                <div class="texto-centralizado">
                    <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“Š</div>
                    <h2>Nenhum Dado de Progresso</h2>
                    <p>FaÃ§a algumas anÃ¡lises de texto para ver suas estatÃ­sticas de progresso.</p>
                    <a href="../dashboard/nova-analise.html" class="botao botao-sucesso" style="margin-top: 20px;">
                        ğŸ“ Fazer Primeira AnÃ¡lise
                    </a>
                </div>
            `;
        }

        function sair() {
            localStorage.removeItem('usuarioLogado');
            window.location.href = '../auth/login.html';
        }

        // Carregar estatÃ­sticas quando a pÃ¡gina carregar
        document.addEventListener('DOMContentLoaded', carregarEstatisticasProgresso);
    </script>
</body>
</html>